---
title: "10.24 Analysis"
author: "yiren"
date: "24/10/2021"
output: html_document
---

```{r setup, include=FALSE}
pacman::p_load(tidyverse, pacman, ggmap, janitor, sf, mapview, leaflet, rgdal, RColorBrewer, ggplot2, data.table, readr, qqplotr, GGally, lubridate, raster, spData, spDataLarge, tmap, osmdata)

# library(remotes)
# remotes::install_github("ropensci/osmdata")
```

## Load data, clean name and get sample

```{r cars}
mytable <- read_csv("data/taxi_trips_2020.csv") %>%
  clean_names() %>%
  print()

set.seed(123)
sample <- mytable %>%
  sample_n(10000)
```

## Map for roads and popular areas
We look at the tag of amenities and find plot out the places where people are likely to take taxi.

```{r}
# available_tags("amenity")

q1 <- getbb("Chicago") %>%
  opq() %>%
  add_osm_feature("amenity", "theatre") %>% osmdata_sf()

q2 <- getbb("Chicago") %>%
  opq() %>%
  add_osm_feature("amenity", "restaurant") %>% osmdata_sf()

q3 <- getbb("Chicago") %>%
  opq() %>%
  add_osm_feature("amenity", "hospital") %>% osmdata_sf()


# str(q4) #query structure
q_all = c (q1, q2, q3)

```



```{r}
mad_map <- get_map(getbb("Chicago"), maptype = "toner-background")

ggmap(mad_map) +
  geom_sf(data = q_all$osm_points,inherit.aes = FALSE, colour = "red",size = 0.5, alpha = 0.1) +
  labs(title = "Chicago", subtitle = "41.8781째N / 87.6298째W") 
  # geom_sf(data = airport$osm_points,inherit.aes = FALSE, colour = "black",size = 1, alpha = 0.3)
```

To make the road more visible, we plot the roads out instead.
```{r}
# available_tags("highway")
big_streets <- getbb("Chicago")%>%
  opq()%>%
  add_osm_feature(key = "highway", 
                  value = c("motorway", "primary", "motorway_link", "primary_link")) %>%
  osmdata_sf()

med_streets <- getbb("Chicago")%>%
  opq()%>%
  add_osm_feature(key = "highway", 
                  value = c("secondary", "tertiary", "secondary_link", "tertiary_link")) %>%
  osmdata_sf()


# small_streets <- getbb("Chicago")%>%
#   opq()%>%
#   add_osm_feature(key = "highway", 
#                   value = c("residential", "living_street",
#                             "unclassified",
#                             "service", "footway"
#                   )) %>%
#   osmdata_sf()


ggplot() +
  geom_sf(data = big_streets$osm_lines,
          inherit.aes = FALSE,
          color = "black",
          size = .3,
          alpha = .3) + 
  geom_sf(data = med_streets$osm_lines,
          inherit.aes = FALSE,
          color = "#666666",
          size = .2,
          alpha = .3) +
  labs(title = "Chicago", subtitle = "41.8781째N / 87.6298째W") +
  theme_void() +
  geom_sf(data = q_all$osm_points,inherit.aes = FALSE, colour = "#238443",
          fill = "#004529",
          alpha = .1,
          size = 1,
          shape = 21) 
    theme(plot.title = element_text(size = 20, family = "lato", face="bold", hjust=.5), plot.subtitle = element_text(family = "lato", size = 8, hjust=.5, margin=margin(2, 0, 5, 0))) 
```
## Basics

```{r}
summary(sample)
sample_gally <- sample %>% dplyr::select(trip_seconds, trip_miles, fare, tips, trip_total)
GGally::ggpairs(sample_gally) + theme_bw(base_size = 22)
```

## Zones vs Revenue
```{r}
zone_rev <- sample %>% 
  dplyr::select(pickup_community_area, dropoff_community_area, trip_total) %>%
  mutate(across(c(pickup_community_area, dropoff_community_area),factor))

pickup_zone <- zone_rev %>% 
  dplyr::select(pickup_community_area, trip_total) %>% 
  drop_na() # remove na now

# keep the zones with highest revenue
pick_up_top <- pickup_zone %>%
  group_by(pickup_community_area) %>% 
  summarise(trip_total = sum(trip_total)) %>%
  arrange(desc(trip_total)) %>%
  top_n(10) 

pick_up_top

# pickup_zone %>%
#   filter(pickup_community_area %in% pick_up_top$pickup_community_area) %>% group_by(pickup_community_area) %>% count()

# pickup$pickup_community_area
pickup_zone %>%
  filter(pickup_community_area %in% pick_up_top$pickup_community_area) %>%
  ggplot(aes(x = pickup_community_area, y = trip_total, fill = pickup_community_area)) +
  geom_boxplot() + 
  scale_y_continuous(limits = c(0, 200)) + # we didn't actually remove the outliners, but to better visualise the data, we zoom in the place where we have the boxplots
  scale_fill_brewer(palette="RdBu") +
  theme_classic()
  
```

It is obvious that zone 76 and zone 8 generate the highest total revenue. However, for a single driver, zone 76 and zone 56 might be preferred since they have a higher average (median) revenue per trip.

We prefer using median over mean because the distribution of revenue is skewed.

drop off 
```{r}
dropoff_zone <- zone_rev %>% 
  dplyr::select(dropoff_community_area, trip_total) %>% 
  drop_na() # remove na now

# keep the zones with highest revenue
drop_off_top <- dropoff_zone %>%
  group_by(dropoff_community_area) %>% 
  summarise(trip_total = sum(trip_total)) %>%
  arrange(desc(trip_total)) %>%
  top_n(10) 

dropoff_zone %>%
  filter(dropoff_community_area %in% drop_off_top$dropoff_community_area) %>%
  ggplot(aes(x = dropoff_community_area, y = trip_total, fill = dropoff_community_area)) +
  geom_boxplot() + 
  scale_y_continuous(limits = c(0, 150)) + # we didn't actually remove the outliners, but to better visualise the data, we zoom in the place where we have the boxplots
  scale_fill_brewer(palette="rainbow") +
  theme_classic()
```

### pickup - dropoff pair total revenue
olav's original codes
```{r}
df1 <- sample %>%
  group_by(pickup_community_area, dropoff_community_area) %>%
  summarise(total = sum(trip_total)) %>%
  # mutate(total=as.factor(total)) %>%
  drop_na()
df1 %>%  
  ggplot(aes(x=pickup_community_area, y=dropoff_community_area)) +
  geom_point(aes(size = total),alpha = 1/2, colour = "orange") +
  theme_bw()
```


## Time vs Zones

```{r}

```




